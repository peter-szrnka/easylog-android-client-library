name: Build Android/Kotlin Library

on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: "Version to use for release"
        required: true
        default: "X.Y.Z"
      developmentVersion:
        description: "Version to use for new local working copy"
        required: true
        default: "X.Y.Z-SNAPSHOT"

jobs:
  release:
    name: Build & Tag Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      tag_name: ${{ steps.create_tag.outputs.tag_name || format('{0}', github.event.inputs.releaseVersion) }}
      tag_exists: ${{ steps.check_tag.outputs.tag_exists }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Check if tag exists
        id: check_tag
        run: |
          TAG_NAME="${{ github.event.inputs.releaseVersion }}"
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
            echo "Tag $TAG_NAME already exists."
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop if tag exists
        if: ${{ steps.check_tag.outputs.tag_exists == 'true' }}
        run: |
          echo "Tag already exists â€” skipping release build."

      - name: Set up JDK 17 for Client (Gradle)
        if: ${{ steps.check_tag.outputs.tag_exists == 'false' }}
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Grant execute permission for Gradlew
        if: ${{ steps.check_tag.outputs.tag_exists == 'false' }}
        run: chmod +x ./gradlew

      - name: Set releaseVersion
        #if: ${{ steps.check_tag.outputs.tag_exists == 'false' }}
        run: |
          sed -i 's/^[[:space:]]*version *= *".*"/version = "${{ github.event.inputs.releaseVersion }}"/' ./client-library/build.gradle.kts
          git config --global user.name ${{ secrets.GH_USERNAME }}
          git config --global user.email ${{ secrets.GH_EMAIL }}
          git add ./client-library/build.gradle.kts
          git commit -m "chore: prepare release ${{ github.event.inputs.releaseVersion }}" || echo "No changes to commit"
          git push origin main

      - name: Build library (Gradle)
        if: ${{ steps.check_tag.outputs.tag_exists == 'false' }}
        run: ./gradlew :client-library:clean :client-library:build

      - name: Create and push release tag
        id: create_tag
        if: ${{ steps.check_tag.outputs.tag_exists == 'false' }}
        run: |
          TAG_NAME="${{ github.event.inputs.releaseVersion }}"
          git config --global user.name ${{ secrets.GH_USERNAME }}
          git config --global user.email ${{ secrets.GH_EMAIL }}
          git fetch origin main
          git checkout main
          git pull origin main
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

  releaseAAR:
    name: Release AAR
    runs-on: ubuntu-latest
    needs: release
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Grant execute permission for Gradlew
        run: chmod +x ./gradlew
      - name: Build AAR
        if: ${{ needs.release.outputs.tag_exists == 'false' }}
        run: ./gradlew :client-library:assembleRelease

      - name: Create or update Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release.outputs.tag_name }}
          name: Release ${{ needs.release.outputs.tag_name }}
          draft: false
          prerelease: false
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload AAR to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release.outputs.tag_name }}
          files: |
            client-library/build/outputs/aar/client-library-release.aar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Trigger JitPack build 
        run: | 
          curl -X GET https://jitpack.io/com/github/peter-szrnka/easylog/${{ github.event.inputs.releaseVersion }}/build.log

  bump-version:
    name: Bump Development Version on main
    runs-on: ubuntu-latest
    needs: release
    if: ${{ needs.release.outputs.tag_exists == 'false' }}
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Update developmentVersion
        run: |
          sed -i 's/^[[:space:]]*version *= *".*"/version = "${{ github.event.inputs.developmentVersion }}"/' ./client-library/build.gradle.kts

      - name: Commit developmentVersion change
        run: |
          git config --global user.name ${{ secrets.GH_USERNAME }}
          git config --global user.email ${{ secrets.GH_EMAIL }}
          git add ./client-library/build.gradle.kts
          git commit -m "[ci-skip] Version updated to ${{ github.event.inputs.developmentVersion }}" || echo "No changes to commit"
          git push origin main
